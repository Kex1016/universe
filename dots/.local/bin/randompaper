#!/usr/bin/env bash
# Randomly select a wallpaper from a specified directory and apply it using Hyprpaper.

random_file_from_dir() {
  local dir="$1"
  if [[ ! -d "$dir" ]]; then
    echo "Error: '$dir' is not a directory" >&2
    return 1
  fi

  local files
  # Find: regular files or symlinks to regular files
  mapfile -d '' files < <(
    find "$dir" -maxdepth 1 \( -type f -o -type l \) -print0 | while IFS= read -r -d '' f; do
      if [[ -f "$f" ]]; then
        printf '%s\0' "$f"
      fi
    done
  )

  if (( ${#files[@]} == 0 )); then
    echo "No regular files or valid symlinks found in '$dir'" >&2
    return 1
  fi

  local idx=$(( RANDOM % ${#files[@]} ))
  printf '%s\n' "${files[$idx]%%$'\0'}"
}

WALLPAPER_DIR="$HOME/.cakepics/$1"
echo "${WALLPAPER_DIR}"

if [[ ! -d "$WALLPAPER_DIR" ]]; then
    echo "Error: '$WALLPAPER_DIR' is not a directory" >&2
    return 1
fi

if [[ "$1" -eq "coven" ]]; then
    WALLPAPER_WIDE=$(random_file_from_dir "$WALLPAPER_DIR/wide")
    WALLPAPER_TALL=$(random_file_from_dir "$WALLPAPER_DIR/tall")
    hyprctl hyprpaper reload DP-1,"$WALLPAPER_WIDE"
    hyprctl hyprpaper reload DP-2,"$WALLPAPER_TALL"
else
    WALLPAPER=$(random_file_from_dir "$WALLPAPER_DIR")
    hyprctl hyprpaper reload ,"$WALLPAPER"
fi

